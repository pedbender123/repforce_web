Guia de Especificação: Repforce 2.0 (v2.1 Final Architecture)

Instruções de Planejamento: Este documento serve como o contrato técnico para o desenvolvimento. Ele define a gramática do motor de fórmulas e a estrutura dos metadados da Engine.

1. Arquitetura Core: Dual Realm

O sistema é dividido em dois domínios isolados:

System Realm: Gere o multitenancy (Empresas), Autenticação (JWT) e permissões globais.

Engine Realm: Camada No-Code que interpreta metadados para gerar tabelas, campos e lógica de negócio dinamicamente.

2. Motor de Fórmulas (Sintaxe AppSheet)

O motor deve processar strings de fórmula e convertê-las em lógica de execução (Backend) ou filtros de interface (Frontend).

2.1. Lógica e Condicionais

IF(cond, verdade, falso): Avaliação condicional simples.

IFS(cond1, v1, cond2, v2, ...): Avaliação de múltiplas condições em sequência.

ISBLANK(campo) / ISNOTBLANK(campo): Verificação de preenchimento.

AND(), OR(), NOT(): Operadores lógicos de agrupamento.

2.2. Usuário e Segurança

USER(): Retorna o objeto completo do usuário ativo.

USERCARGO(): Retorna a função/cargo do utilizador.

USEREMAIL(): Retorna o email do utilizador logado.

2.3. Buscas, Listas e Referências

SELECT(Tabela[Coluna], Filtro): Gera uma lista de valores filtrados.

LOOKUP(valor, tabela, chave, retorno): Busca um valor específico noutra tabela (PROCV).

FILTER(tabela, cond): Retorna os IDs das linhas que satisfazem a condição.

ANY(lista): Extrai o primeiro valor de uma lista (útil com SELECT).

IN(valor, lista): Verifica se um item existe num conjunto.

[Ref].[Coluna]: Dereference - Acessa dados de tabelas relacionadas via coluna de referência.

2.4. Matemática e Agregação

SUM(), COUNT(), AVERAGE(): Operações de agregação sobre listas ou relações.

UNIQUEID(): Gera chaves primárias alfanuméricas aleatórias.

Aritmética básica: Suporte a operadores padrão (ex: [Preço] * [Qtd]).

2.5. Data, Hora e Texto

TODAY(), NOW(), TIMENOW(): Funções de tempo real.

WORKDAY(data, dias): Cálculo de datas excluindo fins de semana.

CONCATENATE(t1, t2, ...): Junção de strings.

SPLIT(texto, separador): Conversão de texto em lista.

3. Engine de Metadados e Colunas Virtuais

A estrutura de metadados (ex: crm_v1.json) deve suportar:

3.1. Colunas Virtuais (VirtualColumns)

Definição do campo formula no metadado.

Snapshots: No momento do SAVE_RECORD, o sistema deve avaliar a fórmula e persistir o resultado numa coluna física correspondente para garantir a integridade histórica (ex: congelar o preço unitário no momento do pedido).